# Esquire Disassembly

This repository contains a living disassembly and annotation of the Esquire 9.04 scheduler, built for the Amiga platform. The goal is to document system behavior, preserve historical software, and enable small targeted fixes through commented assembly.

## Repository Layout
- `src/Prevue.asm` – Root include that pulls in every module. Use it as the entry point for builds.
- `src/modules/groups/` – Feature modules grouped into lettered folders (`a`, `b`, `c`, `d`, etc.) based on shared jump-table/export patterns; use these when tracking related entry stubs.
- `src/modules/submodules/` – Provisional utility chunks split out during the re-org; filenames may remain `unknown*.s` until their roles are confirmed.
- `src/data/` – Display tables, highlight presets, string resources, and lookup maps shared across modules.
- `src/subroutines/` and `src/interrupts/` – Common helpers and interrupt handlers referenced from multiple modules.
- `src/decomp/` – Experimental C decomp/cleanup helpers (reference-only, not part of the build).
- `assets/` – External requirements: Workbench ROM in `kickstart/` and the extracted HDD image in `disks/prevue/`.
- `docs/` – Focused reference notes for recovered file formats and cross-module mapping docs.
- `build/` – Disposable build output regenerated by the scripts.
- `build.sh`, `test-hash.sh` – Helper scripts for assembling and verifying the image with the vasm toolchain.

## Pre-Requisites
- Place the Amiga Workbench 2.04 ROM at `assets/kickstart/v2.04.rom`.
- Download and extract the [Esquire 9.04 HDD image](https://park-city.club/~frix/prevue/Prevue.zip) into `assets/disks/prevue/`.
- Install [vasm](https://sun.hasenbraten.de/vasm/) (m68k, `mot` syntax) and update any hard-coded paths in the scripts to match your setup.
- Optional: Install the [Amiga Assembly](https://marketplace.visualstudio.com/items?itemName=prb28.amiga-assembly) VS Code extension for improved syntax support.

## Build & Verify
1. Ensure the vasm 68k binaries are installed and update their paths inside `build.sh` and `test-hash.sh` if your setup differs.
2. Make the helper scripts executable: `chmod +x build.sh test-hash.sh`.
3. Assemble the project with `./build.sh`. By default this writes `ESQ` to `~/Downloads/Prevue/`; edit the script to change the destination.
4. Confirm determinism with `./test-hash.sh`. A matching build prints `6bd4760d1cf0706297ef169461ed0d7b7f0b079110a78e34d89223499e7c2fa2` as the SHA-256 digest.

For targeted experiments you can run vasm directly, for example:
```bash
~/Downloads/vasm/vasmm68k_mot -Fhunkexe -linedebug -o build/ESQ src/Prevue.asm
```
Keep any generated binaries out of version control.

## Development Workflow
- Alignment/padding bytes found after jump tables are likely compiler artifacts that mark original source/object boundaries; treat them as file-end markers unless proven otherwise.
  - Heuristic only: padding can appear mid-file for alignment, and jump tables are suggestive but not definitive boundaries.
- Some jump tables appear shared across multiple files, likely due to linker layout/segment reuse; grouping under `src/modules/groups/` is a working hypothesis to reflect those shared entry stubs, not a definitive source boundary.
- When you rename a label, keep the original `LAB_xxxx` symbol in place and add the new alias directly above it. This preserves binary parity while growing readable names.
- Record noteworthy alias work and outstanding anonymous labels in [`AGENTS.md`](AGENTS.md) so future passes know where to continue.
- Follow the inline documentation template in `AGENTS.md` for function headers, symbol blocks, and struct offsets; keep notes in code rather than new markdown docs.
- Update adjacent data tables (e.g., entries in `src/data/wdisp.s`) whenever you adjust presets or highlight behavior inside `src/modules/gcommand.s`.
- Re-run `./test-hash.sh` after each change; treat hash deltas as regressions unless intentionally diverging.

## Recent Work
- Completed a full gcommand sweep: all routines now have `GCOMMAND_*` aliases, header blocks, and descriptive local labels (banner/preset pipeline included).
- Banner helpers now include `GCOMMAND_BuildBannerTables`, `GCOMMAND_RebuildBannerTablesFromBounds`, and `GCOMMAND_ServiceHighlightMessages`; see `CONTEXT.md` for the latest rename list.
- Moved `KYBD_UpdateHighlightState` into `src/modules/ladfunc.s` as `LADFUNC_UpdateHighlightState`.
- Added semantic aliases in `src/data/wdisp.s` for Digital Niche/Mplex option-state globals formerly referenced as raw `22D*`/`22E*` offsets (e.g., `GCOMMAND_Niche*` / `GCOMMAND_Mplex*` symbols).
- Renamed local control-flow labels in `src/modules/groups/a/a/bitmap.s` (`BITMAP_ProcessIlbmImage`) and cleaned up NEWGRID local dispatch labels in `src/modules/groups/b/a/newgrid.s` / `src/modules/groups/b/a/newgrid1.s`.

## Contributor Guide
If you plan to extend or annotate the disassembly, read the contributor guidelines in [`AGENTS.md`](AGENTS.md) for module organization, coding style, testing expectations, and review workflow.

## Extra References
- DST file (`df0:dst.dat`) format that dictates daylight savings time start/stop: [`docs/dst-dat-format.md`](docs/dst-dat-format.md)
- LocAvail file (`DF0:LocAvail.dat`) token-stream format used by local availability filters: [`docs/locavail-dat-format.md`](docs/locavail-dat-format.md)
- Config file (`df0:config.dat`) fixed-order serialized layout: [`docs/config-dat-format.md`](docs/config-dat-format.md)
- Programming payload files (`df0:curday.dat`, `df0:nxtday.dat`) layout: [`docs/curday-nxtday-dat-format.md`](docs/curday-nxtday-dat-format.md)
- OI metadata file (`df0:oinfo.dat`) token layout: [`docs/oinfo-dat-format.md`](docs/oinfo-dat-format.md)
- Qtable alias export (`df0:qtable.ini`) format: [`docs/qtable-ini-format.md`](docs/qtable-ini-format.md)
- Promo type file (`df0:PromoId.Dat`) sectioned text format: [`docs/promoid-dat-format.md`](docs/promoid-dat-format.md)
- Source config file (`df0:SourceCfg.ini`) key/value format: [`docs/sourcecfg-ini-format.md`](docs/sourcecfg-ini-format.md)
- Gradient preset file (`df0:Gradient.ini`) range-table format: [`docs/gradient-ini-format.md`](docs/gradient-ini-format.md)
- Parser fixture samples (escaped) for `config.dat` and `LocAvail.dat`: [`docs/examples/README.md`](docs/examples/README.md)
- File-format doc progress tracker: [`docs/file-format-status.md`](docs/file-format-status.md)
